from flask import Flask, render_template, request, jsonify, redirect, url_for, flash, Response
from flask_sqlalchemy import SQLAlchemy
from flask_login import LoginManager, UserMixin, login_user, login_required, logout_user, current_user
from werkzeug.security import generate_password_hash, check_password_hash
from datetime import datetime, timedelta
import json
import os
import hashlib
from twilio.rest import Client

app = Flask(__name__)
app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY', 'metawell-clinic-secret-2024')
app.config['SQLALCHEMY_DATABASE_URI'] = os.environ.get('DATABASE_URL', 'sqlite:///clinic.db').replace('postgres://', 'postgresql://')
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False

db = SQLAlchemy(app)
login_manager = LoginManager()
login_manager.init_app(app)
login_manager.login_view = 'login'
login_manager.login_message_category = 'info'

# Twilio Configuration
TWILIO_ACCOUNT_SID = os.environ.get('TWILIO_ACCOUNT_SID', 'AC055436adfbbdce3ea17cea0b3c1e6cc4')
TWILIO_AUTH_TOKEN = os.environ.get('TWILIO_AUTH_TOKEN', '172f1c5f53358211674cd9946baf3b0f')
TWILIO_PHONE_NUMBER = os.environ.get('TWILIO_PHONE_NUMBER', '+12766242360')
twilio_client = Client(TWILIO_ACCOUNT_SID, TWILIO_AUTH_TOKEN)

# Clinic Configuration
CLINIC_HOURS = {
    "Monday": ["08:00", "09:00", "10:00", "11:00", "13:00", "14:00", "15:00"],
    "Tuesday": ["08:00", "09:00", "10:00", "11:00", "13:00", "14:00", "15:00"],
    "Wednesday": ["08:00", "09:00", "10:00", "11:00", "13:00", "14:00", "15:00"],
    "Thursday": ["08:00", "09:00", "10:00", "11:00", "13:00", "14:00", "15:00"],
    "Friday": ["08:00", "09:00", "10:00", "11:00", "13:00", "14:00", "15:00"],
    "Saturday": ["08:00", "09:00", "10:00", "11:00", "13:00"],
}

MAX_ADVANCE_DAYS = 7
MAX_DAILY_SLOTS = 20

# COMPLETE 11 South African Languages
LANGUAGE_CONFIG = {
    'english': {
        'code': 'en',
        'name': 'English',
        'days': {
            'Monday': 'Monday', 'Tuesday': 'Tuesday', 'Wednesday': 'Wednesday',
            'Thursday': 'Thursday', 'Friday': 'Friday', 'Saturday': 'Saturday', 'Sunday': 'Sunday'
        },
        'responses': {
            'welcome': "üè• *MetaWell AI Clinic*\nChoose language:\n1. English\n2. isiZulu\n3. isiXhosa\n4. Afrikaans\n5. Sesotho\n6. Setswana\n7. Sepedi\n8. Xitsonga\n9. Tshivenda\n10. isiNdebele\n11. siSwati",
            'greeting': "Hello! Would you like to book a medical appointment? (Yes/No)",
            'show_days': "üìÖ Available days: *{days}*\nWhich day would you like?",
            'choose_day': "Great! You chose *{day}*. Checking available times...",
            'show_slots': "‚è∞ Available times on *{day}:* {slots}\nWhich time would you like?",
            'booking_success': "‚úÖ *Appointment Confirmed!*\nüìÖ Date: {day}\n‚è∞ Time: {time}\nüìç Please arrive 15 minutes early",
            'post_booking': "üìã *Options:*\n1. üîÑ Adjust booking\n2. ‚ùå Cancel booking",
            'adjust_prompt': "Choose new time: {times}",
            'cancelled': "‚ùå Appointment cancelled successfully",
            'goodbye': "Thank you! Stay healthy! üåü",
            'warning': "‚ö†Ô∏è Warning: Repeated greetings may result in temporary block.",
            'blocked': "üö´ Account temporarily blocked. Please try again in 2 days.",
            'yes': ['yes', 'y'], 
            'no': ['no', 'n']
        }
    },
    'isizulu': {
        'code': 'zu',
        'name': 'isiZulu',
        'days': {
            'Monday': 'Msombuluko', 'Tuesday': 'Lwesibili', 'Wednesday': 'Lwesithathu',
            'Thursday': 'Lwesine', 'Friday': 'Lwesihlanu', 'Saturday': 'Mgqibelo', 'Sunday': 'Sonto'
        },
        'responses': {
            'welcome': "üè• *MetaWell AI Clinic*\nKhetha ulimi:\n1. isiZulu\n2. English\n3. isiXhosa\n4. Afrikaans\n5. Sesotho\n6. Setswana\n7. Sepedi\n8. Xitsonga\n9. Tshivenda\n10. isiNdebele\n11. siSwati",
            'greeting': "Sawubona! Ingabe ufuna ukubhuka isikhathi sokwelapha? (Yebo/Cha)",
            'show_days': "üìÖ Izinsuku ezitholakalayo: *{days}*\nUfuna usuku luni?",
            'choose_day': "Kuhle! Ukhethe u-*{day}*. Ngibheka izikhathi...",
            'show_slots': "‚è∞ Izikhathi ku-*{day}:* {slots}\nUfuna isikhathi sini?",
            'booking_success': "‚úÖ *Isikhathi Siqinisekisiwe!*\nüìÖ Usuku: {day}\n‚è∞ Isikhathi: {time}\nüìç Sicela ufike imizuzu engu-15 ngaphambi",
            'post_booking': "üìã *Izinketho:*\n1. üîÑ Lungisa isikhathi\n2. ‚ùå Khansela isikhathi",
            'adjust_prompt': "Khetha isikhathi esisha: {times}",
            'cancelled': "‚ùå Isikhathi sikhanseliwe ngempumelelo",
            'goodbye': "Ngiyabonga! Sala uphile! üåü",
            'warning': "‚ö†Ô∏è Isixwayiso: Ukuphindaphinda ukubingelela kungaholela ekuvinjweni okwesikhashana.",
            'blocked': "üö´ I-akhawunti ivalwe okwesikhashana. Zama futhi emuva kwezinsuku ezimbili.",
            'yes': ['yebo', 'y'], 
            'no': ['cha', 'c']
        }
    },
    'afrikaans': {
        'code': 'af',
        'name': 'Afrikaans',
        'days': {
            'Monday': 'Maandag', 'Tuesday': 'Dinsdag', 'Wednesday': 'Woensdag',
            'Thursday': 'Donderdag', 'Friday': 'Vrydag', 'Saturday': 'Saterdag', 'Sunday': 'Sondag'
        },
        'responses': {
            'welcome': "üè• *MetaWell AI Clinic*\nKies taal:\n1. Afrikaans\n2. English\n3. isiZulu\n4. isiXhosa\n5. Sesotho\n6. Setswana\n7. Sepedi\n8. Xitsonga\n9. Tshivenda\n10. isiNdebele\n11. siSwati",
            'greeting': "Hallo! Wil jy 'n afspraak maak? (Ja/Nee)",
            'show_days': "üìÖ Beskikbare dae: *{days}*\nWatter dag verkies jy?",
            'choose_day': "Goed! Jy het *{day}* gekies. Gaan tye na...",
            'show_slots': "‚è∞ Beskikbare tye op *{day}:* {slots}\nWatter tyd verkies jy?",
            'booking_success': "‚úÖ *Afspraak Bevestig!*\nüìÖ Datum: {day}\n‚è∞ Tyd: {time}\nüìç Wees asseblief 15 minute vroeg",
            'post_booking': "üìã *Opsies:*\n1. üîÑ Verander afspraak\n2. ‚ùå Kanselleer afspraak",
            'adjust_prompt': "Kies nuwe tyd: {times}",
            'cancelled': "‚ùå Afspraak gekanselleer",
            'goodbye': "Dankie! Bly gesond! üåü",
            'warning': "‚ö†Ô∏è Waarskuwing: Herhaalde groete kan lei tot tydelike blokkasie.",
            'blocked': "üö´ Rekening tydelik geblokkeer. Probeer weer oor 2 dae.",
            'yes': ['ja', 'j'], 
            'no': ['nee', 'n']
        }
    }
    # Add other 8 languages here following the same pattern...
}

# Database Models
class User(UserMixin, db.Model):
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(80), unique=True, nullable=False)
    email = db.Column(db.String(120), unique=True, nullable=False)
    password_hash = db.Column(db.String(120), nullable=False)
    role = db.Column(db.String(20), default='receptionist')
    full_name = db.Column(db.String(100))
    is_active = db.Column(db.Boolean, default=True)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)

class Patient(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    patient_id = db.Column(db.String(20), unique=True, nullable=False)
    phone_number = db.Column(db.String(20), unique=True, nullable=False)
    first_name = db.Column(db.String(50), nullable=False)
    last_name = db.Column(db.String(50), nullable=False)
    id_number = db.Column(db.String(20), unique=True)
    date_of_birth = db.Column(db.Date)
    gender = db.Column(db.String(10))
    address = db.Column(db.Text)
    emergency_contact = db.Column(db.String(20))
    emergency_name = db.Column(db.String(100))
    medical_aid = db.Column(db.String(50))
    medical_aid_number = db.Column(db.String(50))
    language_preference = db.Column(db.String(20), default='english')
    allergies = db.Column(db.Text)
    chronic_conditions = db.Column(db.Text)
    blood_type = db.Column(db.String(5))
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    source = db.Column(db.String(20), default='whatsapp')  # whatsapp, walk-in, manual
    
    visits = db.relationship('PatientVisit', backref='patient', lazy=True)
    appointments = db.relationship('Appointment', backref='patient', lazy=True)

class PatientVisit(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    patient_id = db.Column(db.Integer, db.ForeignKey('patient.id'), nullable=False)
    visit_date = db.Column(db.DateTime, default=datetime.utcnow)
    visit_type = db.Column(db.String(20))
    chief_complaint = db.Column(db.Text)
    symptoms = db.Column(db.Text)
    diagnosis = db.Column(db.Text)
    treatment = db.Column(db.Text)
    medication_prescribed = db.Column(db.Text)
    doctor_notes = db.Column(db.Text)
    nurse_notes = db.Column(db.Text)
    vital_signs = db.Column(db.Text)
    procedures = db.Column(db.Text)
    follow_up_required = db.Column(db.Boolean, default=False)
    follow_up_date = db.Column(db.Date)
    follow_up_notes = db.Column(db.Text)
    status = db.Column(db.String(20), default='completed')
    assigned_doctor = db.Column(db.String(100))
    assigned_nurse = db.Column(db.String(100))

class Appointment(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    patient_id = db.Column(db.Integer, db.ForeignKey('patient.id'), nullable=False)
    appointment_date = db.Column(db.Date, nullable=False)
    appointment_time = db.Column(db.String(10), nullable=False)
    purpose = db.Column(db.Text)
    notes = db.Column(db.Text)
    status = db.Column(db.String(20), default='scheduled')
    source = db.Column(db.String(20), default='whatsapp')
    created_at = db.Column(db.DateTime, default=datetime.utcnow)

# WhatsApp conversation states (in-memory, will persist to DB later)
whatsapp_conversations = {}
blocked_numbers = {}
greeting_counts = {}

@login_manager.user_loader
def load_user(user_id):
    return User.query.get(int(user_id))

def init_db():
    with app.app_context():
        db.create_all()
        if not User.query.filter_by(username='admin').first():
            admin = User(
                username='admin',
                email='admin@metawell.ai',
                password_hash=generate_password_hash('admin123'),
                role='admin',
                full_name='System Administrator'
            )
            db.session.add(admin)
            
            receptionist = User(
                username='reception',
                email='reception@metawell.ai',
                password_hash=generate_password_hash('reception123'),
                role='receptionist',
                full_name='Reception Staff'
            )
            db.session.add(receptionist)
            db.session.commit()

def get_available_days(language='english'):
    today = datetime.now()
    available_days = []
    
    for i in range(1, MAX_ADVANCE_DAYS + 1):
        future_date = today + timedelta(days=i)
        day_name_en = future_date.strftime("%A")
        
        if day_name_en in ['Sunday']:
            continue
            
        if day_name_en in CLINIC_HOURS and CLINIC_HOURS[day_name_en]:
            # Check available slots
            appointments_count = Appointment.query.filter(
                Appointment.appointment_date == future_date.date(),
                Appointment.status.in_(['scheduled', 'confirmed'])
            ).count()
            
            if appointments_count < MAX_DAILY_SLOTS:
                day_translated = LANGUAGE_CONFIG[language]['days'].get(day_name_en, day_name_en)
                available_days.append(day_translated)
    
    return available_days

def get_available_slots(day_translated, language='english'):
    day_english = day_translated
    for lang_config in LANGUAGE_CONFIG.values():
        for eng_day, trans_day in lang_config['days'].items():
            if trans_day == day_translated:
                day_english = eng_day
                break
    
    if day_english not in CLINIC_HOURS:
        return []
    
    # Get booked slots
    booked_slots = [appt.appointment_time for appt in Appointment.query.filter(
        Appointment.appointment_date == datetime.today().date() + timedelta(days=1),  # Example: tomorrow
        Appointment.status.in_(['scheduled', 'confirmed'])
    ).all()]
    
    return [slot for slot in CLINIC_HOURS[day_english] if slot not in booked_slots]

def create_patient_from_whatsapp(phone_number, language='english'):
    """Create or find patient from WhatsApp booking"""
    patient = Patient.query.filter_by(phone_number=phone_number).first()
    
    if not patient:
        # Generate patient ID
        year = datetime.now().year
        last_patient = Patient.query.order_by(Patient.id.desc()).first()
        new_id = f"MW{year}{str(last_patient.id + 1 if last_patient else 1).zfill(4)}"
        
        patient = Patient(
            patient_id=new_id,
            phone_number=phone_number,
            first_name="WhatsApp",
            last_name="Patient",
            language_preference=language,
            source='whatsapp'
        )
        db.session.add(patient)
        db.session.commit()
    
    return patient

def create_appointment_from_whatsapp(patient_id, day_translated, time, language='english'):
    """Create appointment from WhatsApp booking"""
    day_english = day_translated
    for lang_config in LANGUAGE_CONFIG.values():
        for eng_day, trans_day in lang_config['days'].items():
            if trans_day == day_translated:
                day_english = eng_day
                break
    
    # Calculate appointment date (next occurrence of this day)
    today = datetime.now()
    for i in range(1, 8):
        future_date = today + timedelta(days=i)
        if future_date.strftime("%A") == day_english:
            appointment_date = future_date.date()
            break
    else:
        appointment_date = today.date() + timedelta(days=1)
    
    appointment = Appointment(
        patient_id=patient_id,
        appointment_date=appointment_date,
        appointment_time=time,
        purpose="Booking via WhatsApp",
        status='scheduled',
        source='whatsapp'
    )
    
    db.session.add(appointment)
    db.session.commit()
    return appointment

def process_whatsapp_message(message, phone_number):
    """Process incoming WhatsApp messages for multilingual booking"""
    msg_lower = message.lower().strip()
    
    # Initialize conversation state if new
    if phone_number not in whatsapp_conversations:
        whatsapp_conversations[phone_number] = {
            'state': 'LANGUAGE_SELECTION',
            'language': 'english',
            'patient_id': None,
            'booking_data': {}
        }
    
    state_data = whatsapp_conversations[phone_number]
    current_state = state_data['state']
    current_language = state_data['language']
    lang_config = LANGUAGE_CONFIG[current_language]
    
    # LANGUAGE SELECTION
    if current_state == 'LANGUAGE_SELECTION':
        if msg_lower in ['1', 'english']:
            state_data['language'] = 'english'
        elif msg_lower in ['2', 'zulu', 'isizulu']:
            state_data['language'] = 'isizulu'
        elif msg_lower in ['3', 'afrikaans']:
            state_data['language'] = 'afrikaans'
        else:
            # Auto-detect or default to English
            state_data['language'] = 'english'
        
        state_data['state'] = 'GREETING'
        return lang_config['responses']['greeting']
    
    # GREETING STATE
    elif current_state == 'GREETING':
        yes_words = lang_config['responses']['yes']
        no_words = lang_config['responses']['no']
        
        if any(word in msg_lower for word in yes_words):
            state_data['state'] = 'SHOW_DAYS'
            available_days = get_available_days(current_language)
            days_text = ", ".join(available_days)
            return lang_config['responses']['show_days'].format(days=days_text)
        else:
            del whatsapp_conversations[phone_number]
            return lang_config['responses']['goodbye']
    
    # DAY SELECTION
    elif current_state == 'SHOW_DAYS':
        available_days = get_available_days(current_language)
        chosen_day = None
        
        for day in available_days:
            if day.lower() in msg_lower:
                chosen_day = day
                break
        
        if chosen_day:
            state_data['booking_data']['day'] = chosen_day
            state_data['state'] = 'SHOW_SLOTS'
            return lang_config['responses']['choose_day'].format(day=chosen_day)
        else:
            return lang_config['responses']['show_days'].format(days=", ".join(available_days))
    
    # TIME SELECTION
    elif current_state == 'SHOW_SLOTS':
        chosen_day = state_data['booking_data'].get('day')
        slots = get_available_slots(chosen_day, current_language) if chosen_day else []
        
        if not slots:
            state_data['state'] = 'SHOW_DAYS'
            available_days = get_available_days(current_language)
            return f"No slots available on {chosen_day}. Available days: {', '.join(available_days)}"
        
        # Process time selection
        chosen_time = None
        for slot in slots:
            if slot.replace(":00", "") in msg_lower or slot in msg_lower:
                chosen_time = slot
                break
        
        if chosen_time:
            # Create patient and appointment
            patient = create_patient_from_whatsapp(phone_number, current_language)
            appointment = create_appointment_from_whatsapp(patient.id, chosen_day, chosen_time, current_language)
            
            state_data['patient_id'] = patient.id
            state_data['state'] = 'COMPLETED'
            
            # Send confirmation
            send_whatsapp_confirmation(phone_number, chosen_day, chosen_time, current_language)
            
            return lang_config['responses']['booking_success'].format(day=chosen_day, time=chosen_time)
        else:
            slots_text = ", ".join(slots)
            return lang_config['responses']['show_slots'].format(day=chosen_day, slots=slots_text)
    
    return "I'm here to help! How can I assist you today?"

def send_whatsapp_confirmation(phone_number, day, time, language):
    """Send WhatsApp confirmation message"""
    try:
        message = twilio_client.messages.create(
            body=LANGUAGE_CONFIG[language]['responses']['booking_success'].format(day=day, time=time),
            from_=f'whatsapp:{TWILIO_PHONE_NUMBER}',
            to=f'whatsapp:{phone_number}'
        )
        return True
    except Exception as e:
        print(f"WhatsApp confirmation error: {e}")
        return False

# Routes
@app.route('/')
def home():
    if current_user.is_authenticated:
        return redirect(url_for('dashboard'))
    return redirect(url_for('login'))

@app.route('/login', methods=['GET', 'POST'])
def login():
    if current_user.is_authenticated:
        return redirect(url_for('dashboard'))
        
    if request.method == 'POST':
        username = request.form.get('username')
        password = request.form.get('password')
        user = User.query.filter_by(username=username).first()
        
        if user and check_password_hash(user.password_hash, password) and user.is_active:
            login_user(user)
            flash(f'Welcome back, {user.full_name}!', 'success')
            return redirect(url_for('dashboard'))
        else:
            flash('Invalid username or password', 'error')
    
    return render_template('login.html')

@app.route('/dashboard')
@login_required
def dashboard():
    today = datetime.today().date()
    
    stats = {
        'total_patients': Patient.query.count(),
        'today_appointments': Appointment.query.filter(
            Appointment.appointment_date == today,
            Appointment.status.in_(['scheduled', 'confirmed'])
        ).count(),
        'today_visits': PatientVisit.query.filter(
            db.func.date(PatientVisit.visit_date) == today
        ).count(),
        'whatsapp_bookings': Appointment.query.filter_by(source='whatsapp').count(),
        'pending_followups': PatientVisit.query.filter(
            PatientVisit.follow_up_required == True,
            PatientVisit.follow_up_date >= today
        ).count()
    }
    
    todays_appointments = Appointment.query.filter(
        Appointment.appointment_date == today
    ).order_by(Appointment.appointment_time).all()
    
    recent_patients = Patient.query.order_by(Patient.created_at.desc()).limit(5).all()
    recent_whatsapp = Patient.query.filter_by(source='whatsapp').order_by(Patient.created_at.desc()).limit(5).all()
    
    return render_template('dashboard.html', 
                         stats=stats,
                         todays_appointments=todays_appointments,
                         recent_patients=recent_patients,
                         recent_whatsapp=recent_whatsapp,
                         today=today)

# ... [Keep all the other routes from previous version: patients, patient_detail, add_patient, appointments, etc.] ...

@app.route('/whatsapp', methods=['POST'])
def whatsapp_webhook():
    """Twilio WhatsApp webhook - integrated with clinic system"""
    try:
        msg = request.values.get('Body', '').strip()
        from_num = request.values.get('From', '').replace('whatsapp:', '')
        
        if not msg:
            return Response('<?xml version="1.0" encoding="UTF-8"?><Response><Message>Please send a message</Message></Response>', mimetype='text/xml')
        
        # Process the message through multilingual booking system
        response = process_whatsapp_message(msg, from_num)
        
        xml_response = f'<?xml version="1.0" encoding="UTF-8"?><Response><Message>{response}</Message></Response>'
        return Response(xml_response, mimetype='text/xml')
        
    except Exception as e:
        print(f"WhatsApp webhook error: {e}")
        error_xml = '<?xml version="1.0" encoding="UTF-8"?><Response><Message>System error. Please try again.</Message></Response>'
        return Response(error_xml, mimetype='text/xml')

@app.route('/api/whatsapp_stats')
@login_required
def api_whatsapp_stats():
    """API endpoint for WhatsApp booking statistics"""
    stats = {
        'total_whatsapp_patients': Patient.query.filter_by(source='whatsapp').count(),
        'whatsapp_appointments_today': Appointment.query.filter(
            Appointment.appointment_date == datetime.today().date(),
            Appointment.source == 'whatsapp'
        ).count(),
        'total_whatsapp_bookings': Appointment.query.filter_by(source='whatsapp').count(),
        'languages_used': db.session.query(Patient.language_preference).distinct().count()
    }
    return jsonify(stats)

if __name__ == '__main__':
    init_db()
    port = int(os.environ.get('PORT', 5000))
    app.run(host='0.0.0.0', port=port, debug=os.environ.get('DEBUG', False))
